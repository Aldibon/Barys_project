<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astana Guide - –í—Å–µ –º–µ—Å—Ç–∞ –ê—Å—Ç–∞–Ω—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* –í–µ—Å—å –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π CSS (—Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .search-section { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
        .search-box button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .filter-btn { padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 20px; cursor: pointer; }
        .filter-btn.active { background: #667eea; color: white; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .map-container { background: white; border-radius: 15px; height: 600px; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        .places-list { background: white; border-radius: 15px; padding: 20px; height: 600px; overflow-y: auto; }
        .place-card { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; border-left: 4px solid #667eea; }
        .events-section { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; }
        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .event-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; }
        .error { color: #e53e3e; background: #fff5f5; padding: 15px; border-radius: 10px; text-align: center; }
        .loading { text-align: center; padding: 20px; }
        @media (max-width: 768px) { .content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header"><h1>üó∫Ô∏è Astana Guide</h1><p>–†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Python –ë—ç–∫–µ–Ω–¥</p></div>
    <div class="container">
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." value="—Ä–µ—Å—Ç–æ—Ä–∞–Ω">
                <button onclick="searchPlaces()">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="filters">
                <button class="filter-btn active" onclick="filterPlaces('all')">üè† –í—Å–µ</button>
                <button class="filter-btn" onclick="filterPlaces('restaurant')">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
                <button class="filter-btn" onclick="filterPlaces('hotel')">üè® –û—Ç–µ–ª–∏</button>
                <button class="filter-btn" onclick="filterPlaces('park')">üå≥ –ü–∞—Ä–∫–∏</button>
            </div>
            <div class="info-bar">
                <span id="placesCount">–°–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</span>
                <button class="filter-btn" id="loadMoreBtn" onclick="loadMorePlaces()" disabled>–ï—â–µ</button>
            </div>
        </div>
        <div class="content">
            <div class="map-container"><div id="map"></div></div>
            <div class="places-list">
                <h2>üìç –ú–µ—Å—Ç–∞</h2>
                <div id="placesContainer"></div>
            </div>
        </div>
        <div class="events-section">
            <h2>üìÖ –°–æ–±—ã—Ç–∏—è</h2>
            <div class="events-grid" id="eventsContainer"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const ASTANA_CENTER = [51.1282, 71.4305];
        let map, markers = [], allPlaces = [], currentFilter = 'all', currentPage = 1, isLoading = false;

        window.onload = function() {
            initMap();
            loadEvents();
            searchPlaces(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
        };

        function initMap() {
            map = L.map('map').setView(ASTANA_CENTER, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function loadPlacesFromAPI() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('placesContainer').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const query = document.getElementById('searchInput').value;
                // –ó–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –Ω–∞ –≤–∞—à Python –±—ç–∫–µ–Ω–¥
                const response = await fetch(`/api/places?q=${encodeURIComponent(query)}&page=${currentPage}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∏–º–µ–Ω–Ω–æ JSON, –∞ –Ω–µ HTML –æ—à–∏–±–∫—É
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å Python.");
                }

                const data = await response.json();
                
                if (data.meta && data.meta.code === 200) {
                    const items = data.result.items || [];
                    allPlaces = items.map(item => ({
                        id: item.id,
                        name: item.name,
                        address: item.address_name || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',
                        coordinates: item.point ? [item.point.lat, item.point.lon] : ASTANA_CENTER,
                        category: currentFilter
                    }));
                    renderUI();
                } else {
                    showError(data.meta.error.message || "–û—à–∏–±–∫–∞ API");
                }
            } catch (e) {
                showError(e.message);
            } finally {
                isLoading = false;
                document.getElementById('loadMoreBtn').disabled = false;
            }
        }

        function renderUI() {
            const container = document.getElementById('placesContainer');
            container.innerHTML = allPlaces.map(p => `
                <div class="place-card" onclick="focusOn('${p.id}')">
                    <h3>${p.name}</h3>
                    <p>${p.address}</p>
                </div>
            `).join('');
            
            markers.forEach(m => map.removeLayer(m));
            allPlaces.forEach(p => {
                const m = L.marker(p.coordinates).addTo(map).bindPopup(p.name);
                markers.push(m);
            });
            document.getElementById('placesCount').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${allPlaces.length}`;
        }

        async function loadEvents() {
            const r = await fetch('/api/events');
            const events = await r.json();
            document.getElementById('eventsContainer').innerHTML = events.map(e => `
                <div class="event-card"><h3>${e.title}</h3><p>${e.date}</p><p>${e.location}</p></div>
            `).join('');
        }

        function searchPlaces() { currentPage = 1; loadPlacesFromAPI(); }
        function focusOn(id) { 
            const p = allPlaces.find(x => x.id == id); 
            if(p) map.setView(p.coordinates, 15); 
        }
        function filterPlaces(cat) {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            searchPlaces();
        }
        function showError(m) { document.getElementById('placesContainer').innerHTML = `<div class="error">${m}</div>`; }
        function loadMorePlaces() { currentPage++; loadPlacesFromAPI(); }
    </script>
</body>
</html>
